<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Customer 360 — Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- CDNs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
  <style>
    body{background:#f7f9fc}
    .avatar{width:42px;height:42px;border-radius:50%;object-fit:cover}
    .dropzone{border:1px dashed #c9d3e0;border-radius:10px;padding:10px;text-align:center;color:#6c7a92}
    .dark-mode{background:#0b1320!important;color:#e6eefc}
    .dark-mode .navbar{background:#0e1a33!important}
    .dark-mode .tab-content{background:#0f1f3e!important}
    .dark-mode .table{color:#e6eefc}
    .dark-mode .table thead{background:#132a55}
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="navbar navbar-dark bg-primary shadow-sm">
    <div class="container-fluid">
      <span class="navbar-brand">Customer 360 — Admin Dashboard</span>
      <div class="d-flex gap-2">
        <button class="btn btn-light btn-sm" onclick="toggleDark()"><i class="bi bi-moon"></i></button>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid p-3">
    <ul class="nav nav-tabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#users">3.1 User Management</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#profiles">3.2 Employee Profiles</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#allocation">3.3 Customer Allocation</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#manage">3.4 Manage</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#attendance">3.5 Attendance</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ads">3.6 Advertisement</a></li>
    </ul>

    <div class="tab-content p-3 bg-white border border-top-0 rounded-bottom shadow-sm">

      <!-- 3.1 USER MANAGEMENT -->
      <div class="tab-pane fade show active" id="users">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">User ID</label>
            <input id="um_user_id" class="form-control" placeholder="e.g. emp001 or admin">
          </div>
          <div class="col-md-3">
            <label class="form-label">Password</label>
            <input id="um_password" class="form-control" placeholder="e.g. 1234 / Admin@123">
          </div>
          <div class="col-md-3">
            <label class="form-label">Role</label>
            <select id="um_role" class="form-select"><option value="EMPLOYEE">EMPLOYEE</option><option value="ADMIN">ADMIN</option></select>
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-primary" onclick="createUser()">Create User</button>
          </div>
        </div>
        <hr>
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead class="table-primary"><tr><th>#</th><th>User ID</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="um_tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- 3.2 EMPLOYEE PROFILES -->
      <div class="tab-pane fade" id="profiles">
        <h6 class="fw-bold">Employee Profile Management</h6>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Employee ID</label>
            <input id="ep_empid" class="form-control" placeholder="EMP001">
          </div>
          <div class="col-md-3">
            <label class="form-label">Link to User</label>
            <select id="ep_link_user" class="form-select"></select>
          </div>
          <div class="col-md-3"><label class="form-label">Name</label><input id="ep_name" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">DOB</label><input id="ep_dob" type="date" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">Languages</label><input id="ep_lang" class="form-control" placeholder="English, Hindi"></div>
          <div class="col-md-3"><label class="form-label">Address</label><input id="ep_addr" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">Designation</label><input id="ep_desig" class="form-control" placeholder="Field Executive"></div>
          <div class="col-md-3"><label class="form-label">Reporting Manager</label><input id="ep_mgr" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">Joining</label><input id="ep_join" type="date" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">Relieving</label><input id="ep_relieve" type="date" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">Photo</label><input id="ep_photo" type="file" accept="image/*" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">Resume</label><input id="ep_resume" type="file" accept=".pdf,.doc,.docx" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">Documents</label><input id="ep_docs" type="file" multiple accept=".zip,.jpg,.jpeg,.png" class="form-control"></div>
          <div class="col-md-3 d-grid mt-4">
            <button class="btn btn-primary mb-2" onclick="saveEmployee()">Save Profile</button>
            <button class="btn btn-outline-success" onclick="downloadEmployeeCSV()">Download CSV</button>
          </div>
        </div>

        <hr>
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th><th>Emp ID</th><th>Photo</th><th>Name</th><th>User</th><th>Designation</th>
                <th>Manager</th><th>Joined</th><th>Relieved</th><th>Resume</th><th>Docs</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="ep_tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- 3.3 CUSTOMER ALLOCATION -->
      <div class="tab-pane fade" id="allocation">
        <h6 class="fw-bold">Customer Data Allocation</h6>
        <div class="row g-3 align-items-end">
          <div class="col-lg-6">
            <label class="form-label">Customer CSV</label>
            <input id="ca_csv" type="file" accept=".csv" class="form-control">
            <small class="text-muted">Headers: Name, Phone, Address, PinCode, Principal, TotalOutstanding, EMIAmount, EMIOverdue, OfficeAddress, ProcessStatus, Portfolio, AssetDetails</small>
          </div>
          <div class="col-lg-3">
            <label class="form-label">Assign to Employee</label>
            <select id="ca_emp" class="form-select"></select>
          </div>
          <div class="col-lg-3 d-grid">
            <button class="btn btn-outline-primary mb-2" onclick="allocateCSV()">Upload & Allocate</button>
            <button class="btn btn-danger" onclick="deallocateAllByEmployee()">Deallocate All (Selected)</button>
          </div>
        </div>

        <hr>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>ID</th><th>Name</th><th>Phone</th><th>Address</th><th>Pin</th>
                <th>Principal</th><th>Total</th><th>EMI</th><th>Overdue</th>
                <th>Office</th><th>Process</th><th>Portfolio</th><th>Asset</th>
                <th>Assigned To</th><th>Action</th>
              </tr>
            </thead>
            <tbody id="ca_tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- 3.4 MANAGE -->
      <div class="tab-pane fade" id="manage">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="fw-bold">Employee Feedback / Visit Reports</h6>
          <span class="text-muted small">Edit notes, replace photo, or delete entries</span>
        </div>
        <div class="table-responsive mt-2">
          <table class="table table-sm table-hover align-middle">
            <thead class="table-light">
              <tr><th>#</th><th>Customer</th><th>Employee</th><th>Notes</th><th>Photo</th><th>GPS</th><th>Time</th><th>Actions</th></tr>
            </thead>
            <tbody id="mg_tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- 3.5 ATTENDANCE -->
      <div class="tab-pane fade" id="attendance">
        <div class="row g-3">
          <!-- LEFT: List with filter + CSV -->
          <div class="col-lg-7">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="fw-bold mb-0">Daily Attendance Log</h6>
              <div class="d-flex gap-2 align-items-center">
                <input id="att_date_filter" type="date" class="form-control form-control-sm" style="width:180px" onchange="filterAttendance()">
                <button class="btn btn-sm btn-outline-success" onclick="downloadAttendanceCSV()"><i class="bi bi-download"></i> CSV</button>
                <label class="btn btn-sm btn-outline-primary mb-0">
                  <i class="bi bi-upload"></i> Import
                  <input id="att_csv_import" type="file" accept=".csv" hidden onchange="uploadAttendanceCSV(event)">
                </label>
              </div>
            </div>
            <div class="table-responsive mt-3">
              <table class="table table-sm table-striped align-middle">
                <thead class="table-light"><tr>
                  <th>#</th><th>Emp ID</th><th>Name</th><th>Status</th><th>Login</th><th>Logout</th><th>Date</th>
                </tr></thead>
                <tbody id="att_tbody"></tbody>
              </table>
            </div>
          </div>

          <!-- RIGHT: Calendar + Admin actions -->
          <div class="col-lg-5">
            <div class="card p-3 mb-3">
              <h6 class="fw-bold mb-2">Attendance Calendar</h6>
              <div id="cal"></div>
            </div>
            <div class="card p-3 mb-3">
              <h6 class="fw-bold">Admin Actions</h6>
              <div class="input-group input-group-sm mb-2">
                <input id="at_emp_id" class="form-control" placeholder="Employee ID">
              </div>
              <div class="input-group input-group-sm mb-2">
                <input id="at_date" type="date" class="form-control">
                <select id="at_type" class="form-select">
                  <option value="PRESENT">PRESENT</option>
                  <option value="ABSENT">ABSENT</option>
                  <option value="LEAVE">LEAVE</option>
                </select>
              </div>
              <div class="input-group input-group-sm mb-3">
                <input id="at_login" type="time" class="form-control" placeholder="Login">
                <input id="at_logout" type="time" class="form-control" placeholder="Logout">
              </div>
              <button class="btn btn-outline-primary btn-sm w-100" onclick="markAttendance()">Save</button>
              <hr>
              <div class="input-group input-group-sm mb-2">
                <input id="at_hol_title" class="form-control" placeholder="Holiday Title">
              </div>
              <div class="input-group input-group-sm">
                <input id="at_hol_date" type="date" class="form-control">
                <button class="btn btn-primary" onclick="announceHoliday()">Announce</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 3.6 ADS -->
      <div class="tab-pane fade" id="ads">
        <div class="row g-3 align-items-end">
          <div class="col-lg-6">
            <label class="form-label">Upload Promotional / Incentive Image</label>
            <input id="ad_file" type="file" accept="image/*" class="form-control">
          </div>
          <div class="col-lg-3"><input id="ad_title" class="form-control" placeholder="Title"></div>
          <div class="col-lg-3 d-grid"><button class="btn btn-primary" onclick="uploadAd()">Upload</button></div>
        </div>
        <hr>
        <div id="ad_grid" class="row g-3"></div>
      </div>

    </div>
  </div>

  <!-- Manage/Edit Modal -->
  <div class="modal fade" id="mgEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">Edit Feedback</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input id="mg_edit_id" type="hidden">
          <div class="mb-2"><label class="form-label">Notes</label><textarea id="mg_edit_notes" rows="3" class="form-control"></textarea></div>
          <div class="mb-2"><label class="form-label">Replace Photo</label><input id="mg_edit_photo" type="file" class="form-control" accept="image/*"></div>
          <div class="row g-2"><div class="col"><input id="mg_edit_lat" class="form-control" placeholder="Lat"></div><div class="col"><input id="mg_edit_lng" class="form-control" placeholder="Lng"></div></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" onclick="saveFeedbackEdit()">Save</button></div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.js"></script>
  <script>
    /* ------------ Mock Data ------------ */
    let users = [
      { id:1, user_id:'admin', role:'ADMIN', is_active:1, password:'Admin@123' },
      { id:2, user_id:'emp001', role:'EMPLOYEE', is_active:1, password:'1234' },
      { id:3, user_id:'emp002', role:'EMPLOYEE', is_active:0, password:'1234' },
    ];
    let employees = [
      { id:1, emp_id:'EMP001', user_id:2, name:'Ravi Kumar', dob:'1990-05-10', lang:'Telugu, Hindi', address:'Hyderabad',
        designation:'Field Executive', manager:'Vishal', join:'2023-01-01', relieve:'', photo:'', resume:'', documents:[] },
    ];
    let customers = [
      { id:1001, name:'Ajay Singh', phone:'9998887770', address:'Hyderabad', pincode:'500001',
        principal:100000, total:120000, emi:10000, overdue:2000, office:'Main Branch', process:'Pending', portfolio:'Loan', asset:'A123', assigned_to:1 },
    ];
    let feedbacks = [
      { id:1, customer:'Ajay Singh', employee:'Ravi Kumar', notes:'Promised to pay next week.', photo:'', gps:{lat:'17.3850',lng:'78.4867'}, created_at:new Date().toISOString() }
    ];
    let ads = [{ id:1, title:'Incentive Plan – November', image:'' }];
    let attendanceRecords = [
      {id:1, emp_id:'EMP001', name:'Ravi Kumar', status:'PRESENT', login:'09:15', logout:'18:05', date:new Date().toISOString().slice(0,10)}
    ];

    /* ------------ Helpers ------------ */
    const $ = id => document.getElementById(id);
    function logout(){ location.href='./index.html'; }
    function toggleDark(){ document.body.classList.toggle('dark-mode'); }
    function toast(m){ alert(m); }

    /* ------------ 3.1 Users ------------ */
    function renderUsers(){
      const t=$('um_tbody'); t.innerHTML='';
      users.forEach(u=>{
        t.innerHTML += `<tr>
          <td>${u.id}</td><td>${u.user_id}</td><td>${u.role}</td>
          <td>${u.is_active?'<span class="badge bg-success">Active</span>':'<span class="badge bg-secondary">Inactive</span>'}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-${u.is_active?'warning':'success'}" onclick="toggleUser(${u.id})">${u.is_active?'Deactivate':'Activate'}</button>
              <button class="btn btn-danger" onclick="deleteUser(${u.id})">Delete</button>
            </div>
          </td></tr>`;
      });
      $('ep_link_user').innerHTML = users.map(u=>`<option value="${u.id}">${u.user_id} (${u.role})</option>`).join('');
    }
    function createUser(){
      const user_id=$('um_user_id').value.trim(), password=$('um_password').value.trim(), role=$('um_role').value;
      if(!user_id || !password) return toast('Enter user id & password');
      const id = users.length? Math.max(...users.map(u=>u.id))+1 : 1;
      users.push({id,user_id,role,is_active:1,password});
      $('um_user_id').value=''; $('um_password').value=''; renderUsers(); toast('User created');
    }
    function toggleUser(id){ const u=users.find(x=>x.id===id); if(!u) return; u.is_active = u.is_active?0:1; renderUsers(); }
    function deleteUser(id){ if(!confirm('Delete user?'))return; users = users.filter(u=>u.id!==id); employees = employees.map(e=>e.user_id===id?{...e,user_id:null}:e); renderUsers(); renderProfiles(); }

    /* ------------ 3.2 Profiles ------------ */
    function renderProfiles(){
      const t=$('ep_tbody'); t.innerHTML='';
      employees.forEach(e=>{
        const u = users.find(x=>x.id===e.user_id);
        t.innerHTML += `<tr>
          <td>${e.id}</td>
          <td>${e.emp_id||'-'}</td>
          <td>${e.photo?`<img src="${e.photo}" class="avatar">`:'-'}</td>
          <td>${e.name||''}</td>
          <td>${u?u.user_id:'-'}</td>
          <td>${e.designation||''}</td>
          <td>${e.manager||''}</td>
          <td>${e.join||''}</td>
          <td>${e.relieve||''}</td>
          <td><button class="btn btn-sm btn-outline-success" onclick="viewResume(${e.id})">View</button></td>
          <td><button class="btn btn-sm btn-outline-info" onclick="viewDocs(${e.id})">View</button></td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="editProfile(${e.id})">Edit</button>
              <button class="btn btn-danger" onclick="removeProfile(${e.id})">Delete</button>
            </div>
          </td></tr>`;
      });
      $('ca_emp').innerHTML = employees.map(e=>`<option value="${e.id}">${e.emp_id?e.emp_id+' - ':''}${e.name}</option>`).join('');
    }
    function saveEmployee(){
      const uid=+$('ep_link_user').value || null;
      const profile = {
        id: employees.length? Math.max(...employees.map(e=>e.id))+1 : 1,
        emp_id:$('ep_empid').value.trim(),
        user_id:uid, name:$('ep_name').value.trim(), dob:$('ep_dob').value, lang:$('ep_lang').value.trim(),
        address:$('ep_addr').value.trim(), designation:$('ep_desig').value.trim(), manager:$('ep_mgr').value.trim(),
        join:$('ep_join').value, relieve:$('ep_relieve').value, photo:'', resume:'', documents:[]
      };
      const pf=$('ep_photo').files[0], rf=$('ep_resume').files[0], dfs=$('ep_docs').files;
      const done=()=>{ employees.push(profile); renderProfiles(); toast('Profile saved'); resetProfileInputs(); };
      const readDocs=()=>{ if(!dfs.length) return done(); let c=0; for(let f of dfs){const r=new FileReader(); r.onload=()=>{profile.documents.push(r.result); if(++c===dfs.length)done();}; r.readAsDataURL(f);} };
      const readResume=()=>{ if(!rf) return readDocs(); const r=new FileReader(); r.onload=()=>{profile.resume=r.result; readDocs();}; r.readAsDataURL(rf); };
      const readPhoto=()=>{ if(!pf) return readResume(); const r=new FileReader(); r.onload=()=>{profile.photo=r.result; readResume();}; r.readAsDataURL(pf); };
      readPhoto();
    }
    function resetProfileInputs(){ ['ep_empid','ep_photo','ep_resume','ep_docs','ep_name','ep_dob','ep_lang','ep_addr','ep_desig','ep_mgr','ep_join','ep_relieve'].forEach(id=>{const el=$(id); if(!el) return; el.value='';}); }
    function editProfile(id){ const e=employees.find(x=>x.id===id); if(!e) return;
      $('ep_empid').value=e.emp_id||''; $('ep_link_user').value=e.user_id||''; $('ep_name').value=e.name||''; $('ep_dob').value=e.dob||'';
      $('ep_lang').value=e.lang||''; $('ep_addr').value=e.address||''; $('ep_desig').value=e.designation||''; $('ep_mgr').value=e.manager||'';
      $('ep_join').value=e.join||''; $('ep_relieve').value=e.relieve||''; employees = employees.filter(x=>x.id!==id); renderProfiles();
    }
    function removeProfile(id){ if(!confirm('Delete profile?')) return; employees = employees.filter(e=>e.id!==id); renderProfiles(); }
    function viewResume(id){ const e=employees.find(x=>x.id===id); if(!e||!e.resume) return toast('No resume'); const w=window.open(); w.document.write(`<embed src="${e.resume}" width="100%" height="100%">`); }
    function viewDocs(id){ const e=employees.find(x=>x.id===id); if(!e||!e.documents.length) return toast('No documents'); const w=window.open(); e.documents.forEach(d=>w.document.write(`<img src="${d}" width="220" style="margin:10px;border:1px solid #ccc;">`)); }
    function downloadEmployeeCSV(){
      if(!employees.length) return toast('No employee data');
      const headers=["ID","Employee_ID","User_ID","Name","DOB","Language","Address","Designation","Reporting_Manager","Date_of_Joining","Date_of_Relieving"];
      const rows=employees.map(e=>[e.id,e.emp_id,(users.find(u=>u.id===e.user_id)?.user_id)||"",e.name||"",e.dob||"",e.lang||"",e.address||"",e.designation||"",e.manager||"",e.join||"",e.relieve||""]);
      const csv=[headers.join(","),...rows.map(r=>r.join(","))].join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='employee_profiles.csv'; a.click();
    }

    /* ------------ 3.3 Allocation ------------ */
    function renderAllocations(){
      const t=$('ca_tbody'); t.innerHTML='';
      customers.forEach(c=>{
        const emp=employees.find(e=>e.id===c.assigned_to);
        t.innerHTML += `<tr>
          <td>${c.id}</td><td>${c.name}</td><td>${c.phone||''}</td><td>${c.address||''}</td><td>${c.pincode||''}</td>
          <td>${c.principal||0}</td><td>${c.total||0}</td><td>${c.emi||0}</td><td>${c.overdue||0}</td>
          <td>${c.office||''}</td><td>${c.process||''}</td><td>${c.portfolio||''}</td><td>${c.asset||''}</td>
          <td>${emp?(emp.emp_id?emp.emp_id+' - ':'')+emp.name:'<span class="text-muted">Unassigned</span>'}</td>
          <td>${emp?`<button class="btn btn-sm btn-danger" onclick="deallocateCustomer(${c.id})">Deallocate</button>`:'-'}</td></tr>`;
      });
    }
    function allocateCSV(){
      const f=$('ca_csv').files[0], eid=+$('ca_emp').value;
      if(!f) return toast('Select CSV'); if(!eid) return toast('Select employee');
      const r=new FileReader();
      r.onload=()=>{
        const lines=r.result.split(/\r?\n/).filter(Boolean); const header=lines.shift().split(',');
        const idx=n=>header.findIndex(h=>h.trim().toLowerCase()===n.toLowerCase());
        const ci={name:idx('Name'),phone:idx('Phone'),address:idx('Address'),pin:idx('PinCode'),principal:idx('Principal'),total:idx('TotalOutstanding'),emi:idx('EMIAmount'),overdue:idx('EMIOverdue'),office:idx('OfficeAddress'),process:idx('ProcessStatus'),portfolio:idx('Portfolio'),asset:idx('AssetDetails')};
        lines.forEach(line=>{
          const a=line.split(','); const id=customers.length?Math.max(...customers.map(c=>c.id))+1:1001;
          customers.push({id,name:a[ci.name]||'',phone:a[ci.phone]||'',address:a[ci.address]||'',pincode:a[ci.pin]||'',principal:+(a[ci.principal]||0),total:+(a[ci.total]||0),emi:+(a[ci.emi]||0),overdue:+(a[ci.overdue]||0),office:a[ci.office]||'',process:a[ci.process]||'',portfolio:a[ci.portfolio]||'',asset:a[ci.asset]||'',assigned_to:eid});
        });
        renderAllocations(); toast('CSV allocated');
      };
      r.readAsText(f);
    }
    function deallocateCustomer(id){ const c=customers.find(x=>x.id===id); if(!c||!c.assigned_to) return; if(confirm('Deallocate this customer?')){ c.assigned_to=null; renderAllocations(); } }
    function deallocateAllByEmployee(){ const eid=+$('ca_emp').value; if(!eid) return toast('Select employee'); const count=customers.filter(c=>c.assigned_to===eid).length; if(!count) return toast('No customers for this employee'); if(confirm(`Deallocate ALL ${count} customers?`)){ customers=customers.map(c=>c.assigned_to===eid?{...c,assigned_to:null}:c); renderAllocations(); } }

    /* ------------ 3.4 Manage ------------ */
    function renderManage(){
      const t=$('mg_tbody'); t.innerHTML='';
      feedbacks.forEach(f=>{
        t.innerHTML += `<tr>
          <td>${f.id}</td><td>${f.customer}</td><td>${f.employee}</td><td class="small">${f.notes||''}</td>
          <td>${f.photo?`<img src="${f.photo}" class="avatar">`:'-'}</td>
          <td><a href="https://maps.google.com/?q=${f.gps.lat},${f.gps.lng}" target="_blank">${f.gps.lat}, ${f.gps.lng}</a></td>
          <td>${new Date(f.created_at).toLocaleString()}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="openEdit(${f.id})">Edit</button>
              <button class="btn btn-danger" onclick="deleteFeedback(${f.id})">Delete</button>
            </div>
          </td></tr>`;
      });
    }
    function openEdit(id){ const f=feedbacks.find(x=>x.id===id); if(!f) return;
      $('mg_edit_id').value=f.id; $('mg_edit_notes').value=f.notes||''; $('mg_edit_lat').value=f.gps.lat||''; $('mg_edit_lng').value=f.gps.lng||'';
      new bootstrap.Modal($('#mgEditModal')).show();
    }
    function saveFeedbackEdit(){ const id=+$('mg_edit_id').value; const f=feedbacks.find(x=>x.id===id); if(!f) return;
      f.notes=$('mg_edit_notes').value.trim(); f.gps={lat:$('mg_edit_lat').value.trim(),lng:$('mg_edit_lng').value.trim()};
      const file=$('mg_edit_photo').files[0]; if(file){ const r=new FileReader(); r.onload=()=>{f.photo=r.result; renderManage(); toast('Updated');}; r.readAsDataURL(file);} else { renderManage(); toast('Updated'); }
      bootstrap.Modal.getInstance($('#mgEditModal')).hide(); $('mg_edit_photo').value='';
    }
    function deleteFeedback(id){ if(!confirm('Delete?'))return; feedbacks = feedbacks.filter(f=>f.id!==id); renderManage(); }

    /* ------------ 3.5 Attendance ------------ */
    let calendar;
    function initCalendar(){
      calendar = new FullCalendar.Calendar($('cal'), {
        initialView:'dayGridMonth',
        height: 520,
        dateClick:(info)=>{ if(confirm(`Mark public holiday on ${info.dateStr}?`)){ calendar.addEvent({title:'HOLIDAY',start:info.dateStr,allDay:true,color:'#dc3545'}); } }
      });
      calendar.render();
    }
    function renderAttendanceTable(list=attendanceRecords){
      const t=$('att_tbody'); t.innerHTML='';
      list.forEach((r,i)=>{
        t.innerHTML += `<tr>
          <td>${i+1}</td><td>${r.emp_id}</td><td>${r.name}</td>
          <td><span class="badge ${r.status==='PRESENT'?'bg-success':r.status==='ABSENT'?'bg-danger':'bg-warning text-dark'}">${r.status}</span></td>
          <td>${r.login||'-'}</td><td>${r.logout||'-'}</td><td>${r.date}</td></tr>`;
      });
    }
    function filterAttendance(){ const d=$('att_date_filter').value; renderAttendanceTable(d?attendanceRecords.filter(a=>a.date===d):attendanceRecords); }
    function markAttendance(){
      const emp_id=$('at_emp_id').value.trim(), date=$('at_date').value, status=$('at_type').value, login=$('at_login').value, logout=$('at_logout').value;
      const emp=employees.find(e=>e.emp_id===emp_id); const name=emp?emp.name:'Unknown';
      if(!emp_id||!date) return toast('Employee ID & Date required');
      const existing = attendanceRecords.find(a=>a.emp_id===emp_id && a.date===date);
      if(existing){ existing.status=status; existing.login=login; existing.logout=logout; }
      else { attendanceRecords.push({id:Date.now(), emp_id, name, status, login, logout, date}); }
      renderAttendanceTable(); toast('Saved'); $('at_emp_id').value=''; $('at_date').value=''; $('at_login').value=''; $('at_logout').value='';
    }
    function downloadAttendanceCSV(){
      const d=$('att_date_filter').value; const list=d?attendanceRecords.filter(a=>a.date===d):attendanceRecords;
      if(!list.length) return toast('No records to export');
      const headers=["Emp ID","Name","Status","Login","Logout","Date"];
      const rows=list.map(r=>[r.emp_id,r.name,r.status,r.login||"-",r.logout||"-",r.date]);
      const csv=[headers.join(","),...rows.map(r=>r.join(","))].join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`attendance_${d||'all'}.csv`; a.click();
    }
    function uploadAttendanceCSV(e){
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=ev=>{
        const lines=ev.target.result.split(/\r?\n/).filter(Boolean); const head=lines[0].trim().split(",");
        const required=["emp_id","name","status","login","logout","date"]; const valid=required.every(h=>head.includes(h));
        if(!valid) return alert("Invalid CSV. Headers must be: emp_id,name,status,login,logout,date");
        lines.slice(1).forEach(line=>{
          const [emp_id,name,status,login,logout,date]=line.split(",");
          const ex=attendanceRecords.find(a=>a.emp_id===emp_id && a.date===date);
          if(ex){ Object.assign(ex,{name,status,login,logout,date}); }
          else { attendanceRecords.push({id:Date.now()+Math.random(),emp_id,name,status,login,logout,date}); }
        });
        renderAttendanceTable(); alert('Attendance imported'); $('att_csv_import').value='';
      };
      r.readAsText(f);
    }
    function announceHoliday(){ const t=$('at_hol_title').value.trim()||'HOLIDAY', d=$('at_hol_date').value; if(!d) return toast('Pick a date'); calendar.addEvent({title:t,start:d,allDay:true,color:'#dc3545'}); toast('Holiday announced'); $('at_hol_title').value=''; $('at_hol_date').value=''; }

    /* ------------ 3.6 Ads ------------ */
    function renderAds(){
      const grid=$('ad_grid'); grid.innerHTML='';
      ads.forEach(a=>{
        grid.innerHTML += `<div class="col-md-4"><div class="card h-100 shadow-sm">
          ${a.image?`<img src="${a.image}" class="card-img-top" style="max-height:220px;object-fit:cover;">`:`<div class="dropzone">No Image</div>`}
          <div class="card-body"><div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">${a.title||'Untitled'}</h6>
            <div class="btn-group btn-group-sm"><button class="btn btn-warning" onclick="toggleAd(${a.id})">Toggle</button><button class="btn btn-danger" onclick="removeAd(${a.id})">Delete</button></div>
          </div><div class="small text-muted mt-1">ID: ${a.id}</div></div></div></div>`;
      });
    }
    function uploadAd(){ const f=$('ad_file').files[0]; const title=$('ad_title').value.trim()||'Announcement'; const id=ads.length?Math.max(...ads.map(a=>a.id))+1:1; const ad={id,title,image:''};
      if(f){ const r=new FileReader(); r.onload=()=>{ad.image=r.result; ads.push(ad); renderAds(); toast('Uploaded');}; r.readAsDataURL(f); } else { ads.push(ad); renderAds(); toast('Uploaded'); }
      $('ad_file').value=''; $('ad_title').value='';
    }
    function toggleAd(id){ toast(`Ad #${id} toggled (mock)`); }
    function removeAd(id){ if(!confirm('Delete ad?'))return; ads=ads.filter(a=>a.id!==id); renderAds(); }

    /* ------------ Init ------------ */
    document.addEventListener('DOMContentLoaded', ()=>{
      renderUsers(); renderProfiles(); renderAllocations(); renderManage(); renderAds(); initCalendar(); renderAttendanceTable();
    });
  </script>
</body>
</html>
